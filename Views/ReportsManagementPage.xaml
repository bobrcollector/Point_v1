<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="Point_v1.Views.ReportsManagementPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:Point_v1.Models"
             xmlns:converters="clr-namespace:Point_v1.Converters"
             Title="Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¶Ð°Ð»Ð¾Ð±Ð°Ð¼Ð¸"
             Shell.NavBarIsVisible="True"
             BackgroundColor="{AppThemeBinding Light=#F8F9FA, Dark=#1C1C1E}">

    <ContentPage.Resources>
        <converters:ReportTypeConverter x:Key="ReportTypeConverter" />
        <converters:ReportStatusConverter x:Key="ReportStatusConverter" />
        <converters:ReportColorConverter x:Key="ReportColorConverter" />
        <converters:NegativeBooleanConverter x:Key="NegativeBooleanConverter" />
        <converters:ShowReportActionsConverter x:Key="ShowReportActionsConverter" />
        <converters:ShowResolutionInfoConverter x:Key="ShowResolutionInfoConverter" />
        <converters:TabColorConverter x:Key="TabColorConverter" />
        <converters:TabTextColorConverter x:Key="TabTextColorConverter" />
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,Auto,*,Auto">

        <!-- Ð’ÐºÐ»Ð°Ð´ÐºÐ¸ (ÐºÐ¾Ð¼Ð¿Ð°ÐºÑ‚Ð½Ñ‹Ðµ, ÑÑ€Ð°Ð·Ñƒ Ð¿Ð¾Ð´ ÑˆÐ°Ð¿ÐºÐ¾Ð¹) -->
        <VerticalStackLayout Grid.Row="1" 
                             Spacing="0" 
                             VerticalOptions="End"
                             Margin="20,10,20,0">

            <Grid ColumnDefinitions="*,*"
                  BackgroundColor="{AppThemeBinding Light=#F0F0F0, Dark=#3A3A3A}"
                  HeightRequest="40"
                  Margin="0">

                <!-- ÐžÐ¶Ð¸Ð´Ð°ÑŽÑ‰Ð¸Ðµ -->
                <Frame Grid.Column="0"
                       BackgroundColor="{Binding SelectedTab, Converter={x:StaticResource TabColorConverter}, ConverterParameter=Pending}"
                       CornerRadius="6"
                       HasShadow="False"
                       Padding="0"
                       Margin="2">
                    <Button Text="â³ ÐžÐ¶Ð¸Ð´Ð°ÑŽÑ‰Ð¸Ðµ" 
                            Command="{Binding SwitchTabCommand}"
                            CommandParameter="Pending"
                            BackgroundColor="Transparent"
                            TextColor="{Binding SelectedTab, Converter={x:StaticResource TabTextColorConverter}, ConverterParameter=Pending}"
                            FontSize="12"
                            HeightRequest="32"/>
                </Frame>

                <!-- Ð ÐµÑˆÐµÐ½Ð½Ñ‹Ðµ -->
                <Frame Grid.Column="1"
                       BackgroundColor="{Binding SelectedTab, Converter={x:StaticResource TabColorConverter}, ConverterParameter=Resolved}"
                       CornerRadius="6"
                       HasShadow="False"
                       Padding="0"
                       Margin="2">
                    <Button Text="âœ… Ð ÐµÑˆÐµÐ½Ð½Ñ‹Ðµ" 
                            Command="{Binding SwitchTabCommand}"
                            CommandParameter="Resolved"
                            BackgroundColor="Transparent"
                            TextColor="{Binding SelectedTab, Converter={x:StaticResource TabTextColorConverter}, ConverterParameter=Resolved}"
                            FontSize="12"
                            HeightRequest="32"/>
                </Frame>
            </Grid>
        </VerticalStackLayout>

        <!-- Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð¶Ð°Ð»Ð¾Ð± (Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ð±ÐµÐ· Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹) -->
        <RefreshView Grid.Row="2" 
                     Command="{Binding LoadReportsCommand}"
                     IsRefreshing="{Binding IsLoading}">

            <CollectionView ItemsSource="{Binding Reports}"
                            SelectionMode="None">

                <CollectionView.EmptyView>
                    <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center" Spacing="15" Margin="20">
                        <Label Text="ðŸ“" FontSize="40" HorizontalOptions="Center"/>
                        <Label Text="{Binding EmptyMessage}" 
                               FontSize="16"
                               FontAttributes="Bold"
                               HorizontalOptions="Center"
                               HorizontalTextAlignment="Center"/>
                    </VerticalStackLayout>
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Report">
                        <Grid Padding="15,8">
                            <Frame BackgroundColor="{Binding Status, Converter={x:StaticResource ReportColorConverter}}"
                                   Padding="15"
                                   CornerRadius="15"
                                   HasShadow="True">

                                <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto" 
                                      ColumnDefinitions="*,Auto"
                                      RowSpacing="8">

                                    <!-- Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº -->
                                    <Label Grid.Row="0" Grid.Column="0"
                                           Text="{Binding Type, Converter={x:StaticResource ReportTypeConverter}}"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           LineBreakMode="TailTruncation"/>

                                    <Label Grid.Row="0" Grid.Column="1"
                                           Text="{Binding Status, Converter={x:StaticResource ReportStatusConverter}}"
                                           FontSize="11"
                                           FontAttributes="Bold"
                                           TextColor="Gray"/>

                                    <!-- Ð”Ð°Ñ‚Ð° -->
                                    <Label Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                           Text="{Binding CreatedAt, StringFormat='Ð¡Ð¾Ð·Ð´Ð°Ð½Ð°: {0:dd.MM.yyyy HH:mm}'}"
                                           FontSize="12"
                                           TextColor="Gray"/>

                                    <!-- ID ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ -->
                                    <Label Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2"
                                           Text="{Binding TargetEventId, StringFormat='Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ðµ: {0}'}"
                                           FontSize="12"
                                           TextColor="Gray"
                                           LineBreakMode="TailTruncation"/>

                                    <!-- ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð° -->
                                    <Label Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2"
                                           Text="{Binding Reason, StringFormat='ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð°: {0}'}"
                                           FontSize="12"
                                           TextColor="Gray"
                                           LineBreakMode="WordWrap"
                                           MaxLines="3"/>

                                    <!-- ÐšÐ½Ð¾Ð¿ÐºÐ¸ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ -->
                                    <Grid Grid.Row="4" Grid.Column="0" Grid.ColumnSpan="2"
                                          ColumnDefinitions="*,Auto"
                                          ColumnSpacing="10"
                                          IsVisible="{Binding Status, Converter={x:StaticResource ShowReportActionsConverter}}">

                                        <!-- ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ -->
                                        <Button Grid.Column="0"
                                                Text="ðŸ” Ð Ð°ÑÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ResolveReportCommand}"
                                                CommandParameter="{Binding .}"
                                                BackgroundColor="{AppThemeBinding Light=#512BD4, Dark=#512BD4}"
                                                TextColor="White"
                                                HeightRequest="35"
                                                CornerRadius="8"
                                                FontSize="12"/>

                                        <!-- ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ -->
                                        <Button Grid.Column="1"
                                                Text="ðŸ‘ï¸ Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ðµ"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ViewEventCommand}"
                                                CommandParameter="{Binding TargetEventId}"
                                                BackgroundColor="Transparent"
                                                TextColor="{AppThemeBinding Light=#512BD4, Dark=#9880e5}"
                                                BorderColor="{AppThemeBinding Light=#512BD4, Dark=#9880e5}"
                                                BorderWidth="1"
                                                HeightRequest="35"
                                                CornerRadius="8"
                                                FontSize="12"/>
                                    </Grid>

                                    <!-- Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ñ€ÐµÑˆÐµÐ½Ð¸Ð¸ -->
                                    <VerticalStackLayout Grid.Row="4" Grid.Column="0" Grid.ColumnSpan="2"
                                                         Spacing="4"
                                                         IsVisible="{Binding Status, Converter={x:StaticResource ShowResolutionInfoConverter}}">

                                        <Label Text="{Binding ModeratorNotes, StringFormat='Ð ÐµÑˆÐµÐ½Ð¸Ðµ: {0}'}"
                                               FontSize="12"
                                               TextColor="Gray"
                                               LineBreakMode="WordWrap"/>

                                        <Label Text="{Binding ResolvedAt, StringFormat='Ð ÐµÑˆÐµÐ½Ð¾: {0:dd.MM.yyyy HH:mm}'}"
                                               FontSize="11"
                                               TextColor="Gray"/>
                                    </VerticalStackLayout>

                                </Grid>
                            </Frame>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <!-- Ð˜Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ -->
        <ActivityIndicator Grid.Row="1" Grid.RowSpan="2"
                           IsRunning="{Binding IsLoading}"
                           IsVisible="{Binding IsLoading}"
                           Color="#512BD4"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"/>

    </Grid>
</ContentPage>