<ContentPage x:Class="Point_v1.Views.MyEventsPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:Point_v1.Models"
             xmlns:converters="clr-namespace:Point_v1.Converters"
             Title="Мои события">

    <ContentPage.Resources>
        <!-- РЕГИСТРИРУЕМ ВСЕ КОНВЕРТЕРЫ -->
        <converters:TabColorConverter x:Key="TabColorConverter" />
        <converters:TabTextColorConverter x:Key="TabTextColorConverter" />
        <converters:ShowActionsConverter x:Key="ShowActionsConverter" />
        <converters:ShowEditButtonConverter x:Key="ShowEditButtonConverter" />
        <converters:ShowLeaveButtonConverter x:Key="ShowLeaveButtonConverter" />
        <converters:NegativeBooleanConverter x:Key="NegativeBooleanConverter" />
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*,Auto">

        <!-- Вкладки -->
        <Grid Grid.Row="0" 
              ColumnDefinitions="*,*,*"
              BackgroundColor="{AppThemeBinding Light=#F0F0F0, Dark=#3A3A3A}"
              HeightRequest="45"
              Margin="10,10,10,5">

            <!-- Созданные мной -->
            <Frame Grid.Column="0"
                   BackgroundColor="{Binding SelectedTab, Converter={x:StaticResource TabColorConverter}, ConverterParameter=Created}"
                   CornerRadius="8"
                   HasShadow="False"
                   Padding="0"
                   Margin="2">
                <Button Text="Созданные" 
                        Command="{Binding SwitchTabCommand}"
                        CommandParameter="Created"
                        BackgroundColor="Transparent"
                        TextColor="{Binding SelectedTab, Converter={x:StaticResource TabTextColorConverter}, ConverterParameter=Created}"
                        FontSize="12"
                        HeightRequest="35"/>
            </Frame>

            <!-- Я участвую -->
            <Frame Grid.Column="1"
                   BackgroundColor="{Binding SelectedTab, Converter={x:StaticResource TabColorConverter}, ConverterParameter=Participating}"
                   CornerRadius="8"
                   HasShadow="False"
                   Padding="0"
                   Margin="2">
                <Button Text="Участвую" 
                        Command="{Binding SwitchTabCommand}"
                        CommandParameter="Participating"
                        BackgroundColor="Transparent"
                        TextColor="{Binding SelectedTab, Converter={x:StaticResource TabTextColorConverter}, ConverterParameter=Participating}"
                        FontSize="12"
                        HeightRequest="35"/>
            </Frame>

            <!-- Архив -->
            <Frame Grid.Column="2"
                   BackgroundColor="{Binding SelectedTab, Converter={x:StaticResource TabColorConverter}, ConverterParameter=Archived}"
                   CornerRadius="8"
                   HasShadow="False"
                   Padding="0"
                   Margin="2">
                <Button Text="Архив" 
                        Command="{Binding SwitchTabCommand}"
                        CommandParameter="Archived"
                        BackgroundColor="Transparent"
                        TextColor="{Binding SelectedTab, Converter={x:StaticResource TabTextColorConverter}, ConverterParameter=Archived}"
                        FontSize="12"
                        HeightRequest="35"/>
            </Frame>
        </Grid>

        <!-- Список событий -->
        <RefreshView Grid.Row="1" 
                     Command="{Binding LoadEventsCommand}"
                     IsRefreshing="{Binding IsLoading}">

            <CollectionView ItemsSource="{Binding CurrentEvents}"
                            SelectionMode="None">

                <CollectionView.EmptyView>
                    <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center" Spacing="15" Margin="20">
                        <Label Text="📅" FontSize="40" HorizontalOptions="Center"/>
                        <Label Text="{Binding EmptyViewMessage}" 
                               FontSize="16"
                               FontAttributes="Bold"
                               HorizontalOptions="Center"
                               HorizontalTextAlignment="Center"/>
                    </VerticalStackLayout>
                </CollectionView.EmptyView>

                <!-- Шаблон события -->
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Event">
                        <Grid Padding="15,8">
                            <Frame Padding="15" 
                                   CornerRadius="15" 
                                   HasShadow="True"
                                   BackgroundColor="{AppThemeBinding Light=White, Dark=#2C2C2E}">

                                <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto" 
                                      ColumnDefinitions="*,Auto"
                                      RowSpacing="8">

                                    <!-- Заголовок и дата -->
                                    <Label Grid.Row="0" Grid.Column="0"
                                           Text="{Binding Title}" 
                                           FontSize="16" 
                                           FontAttributes="Bold"
                                           LineBreakMode="TailTruncation"/>

                                    <Label Grid.Row="0" Grid.Column="1"
                                           Text="{Binding DateDisplay}" 
                                           FontSize="12"
                                           TextColor="Gray"/>

                                    <!-- Описание -->
                                    <Label Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                           Text="{Binding ShortDescription}" 
                                           FontSize="14"
                                           LineBreakMode="TailTruncation"
                                           MaxLines="2"/>

                                    <!-- Адрес -->
                                    <Label Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2"
                                           Text="{Binding Address}" 
                                           FontSize="12"
                                           TextColor="Gray"
                                           LineBreakMode="TailTruncation"/>

                                    <!-- Категория и участники -->
                                    <Grid Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2"
                                          ColumnDefinitions="*,Auto">

                                        <!-- Категория -->
                                        <Frame Grid.Column="0"
                                               BackgroundColor="#DFD8F7"
                                               Padding="8,4"
                                               CornerRadius="8"
                                               HasShadow="False"
                                               HorizontalOptions="Start">
                                            <Label Text="{Binding CategoryId}" 
                                                   FontSize="12"
                                                   TextColor="#512BD4"/>
                                        </Frame>

                                        <!-- Участники -->
                                        <Label Grid.Column="1"
                                               Text="{Binding ParticipantsDisplay}" 
                                               FontSize="12"
                                               TextColor="Gray"/>
                                    </Grid>

                                    <!-- Кнопки действий -->
                                    <Grid Grid.Row="4" Grid.Column="0" Grid.ColumnSpan="2"
                                          ColumnDefinitions="*,Auto"
                                          IsVisible="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SelectedTab, Converter={x:StaticResource ShowActionsConverter}}">

                                        <!-- Кнопка редактирования (только для созданных) -->
                                        <Button Grid.Column="0"
                                                Text="✏️ Редактировать"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.EditEventCommand}"
                                                CommandParameter="{Binding Id}"
                                                BackgroundColor="Transparent"
                                                TextColor="#512BD4"
                                                BorderColor="#512BD4"
                                                BorderWidth="1"
                                                HeightRequest="35"
                                                Margin="0,0,5,0"
                                                CornerRadius="8"
                                                FontSize="12"
                                                IsVisible="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SelectedTab, Converter={x:StaticResource ShowEditButtonConverter}}"/>

                                        <!-- Кнопка выхода (только для участия) -->
                                        <Button Grid.Column="1"
                                                Text="🚫 Выйти"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.LeaveEventCommand}"
                                                CommandParameter="{Binding Id}"
                                                BackgroundColor="#FF6B6B"
                                                TextColor="White"
                                                HeightRequest="35"
                                                Margin="5,0,0,0"
                                                CornerRadius="8"
                                                FontSize="12"
                                                IsVisible="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SelectedTab, Converter={x:StaticResource ShowLeaveButtonConverter}}"/>
                                    </Grid>
                                </Grid>
                            </Frame>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <!-- Индикатор загрузки -->
        <ActivityIndicator Grid.Row="0" Grid.RowSpan="2"
                           IsRunning="{Binding IsLoading}"
                           IsVisible="{Binding IsLoading}"
                           Color="#512BD4"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"/>
    </Grid>
</ContentPage>
