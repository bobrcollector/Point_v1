<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="Point_v1.Views.CreateEventPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:Point_v1.Converters"
             Title="Создать событие"
             BackgroundColor="{AppThemeBinding Light=#F8F9FA, Dark=#1C1C1E}">

    <ScrollView>
        <VerticalStackLayout Spacing="0">

            <!-- Заголовок -->
            <Frame BackgroundColor="#512BD4"
                   Padding="25,40"
                   CornerRadius="0"
                   HasShadow="True">
                <VerticalStackLayout Spacing="10">
                    <Label Text="🎉" 
                           FontSize="30"
                           HorizontalOptions="Center"/>

                    <Label Text="Создать событие" 
                           FontSize="24" 
                           TextColor="White"
                           FontAttributes="Bold"
                           HorizontalOptions="Center"/>

                    <Label Text="Расскажите о вашем мероприятии" 
                           FontSize="14" 
                           TextColor="#DFD8F7"
                           HorizontalOptions="Center"/>
                </VerticalStackLayout>
            </Frame>

            <!-- Форма -->
            <VerticalStackLayout Spacing="20" Padding="25" BackgroundColor="Transparent">

                <!-- Сообщения об ошибках -->
                <Label Text="{Binding ErrorMessage}" 
                       IsVisible="{Binding ErrorMessage, Converter={converters:IsNotNullOrEmptyConverter}}"
                       TextColor="#D32F2F" 
                       FontSize="14"
                       HorizontalOptions="Center"
                       Padding="15,10"
                       HorizontalTextAlignment="Center"
                       Margin="0,0,0,10"/>

                <!-- Название -->
                <VerticalStackLayout Spacing="8">
                    <Label Text="Название события *" 
                           FontSize="14" 
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light=#333, Dark=White}"/>
                    <Entry Placeholder="Например: Вечер настольных игр" 
                           Text="{Binding Title}"
                           BackgroundColor="{AppThemeBinding Light=White, Dark=#2C2C2E}"
                           TextColor="{AppThemeBinding Light=Black, Dark=White}"
                           HeightRequest="50"/>
                </VerticalStackLayout>

                <!-- Описание -->
                <VerticalStackLayout Spacing="8">
                    <Label Text="Описание *" 
                           FontSize="14" 
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light=#333, Dark=White}"/>
                    <Editor Placeholder="Опишите ваше событие подробнее..." 
                            Text="{Binding Description}"
                            BackgroundColor="{AppThemeBinding Light=White, Dark=#2C2C2E}"
                            TextColor="{AppThemeBinding Light=Black, Dark=White}"
                            HeightRequest="120"
                            AutoSize="TextChanges"/>
                </VerticalStackLayout>

                <!-- Категория -->
                <VerticalStackLayout Spacing="8">
                    <Label Text="Категория *" 
                           FontSize="14" 
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light=#333, Dark=White}"/>
                    <Picker Title="Выберите категорию..." 
                            ItemsSource="{Binding Interests}"
                            ItemDisplayBinding="{Binding Name}"
                            SelectedItem="{Binding SelectedInterest}"
                            BackgroundColor="{AppThemeBinding Light=White, Dark=#2C2C2E}"
                            TextColor="{AppThemeBinding Light=Black, Dark=White}"
                            HeightRequest="50"/>
                </VerticalStackLayout>

                <!-- Дата и время -->
                <Grid ColumnDefinitions="*,*" ColumnSpacing="15">
                    <VerticalStackLayout Grid.Column="0" Spacing="8">
                        <Label Text="Дата *" 
                               FontSize="14" 
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light=#333, Dark=White}"/>
                        <DatePicker Date="{Binding EventDate}"
                                    MinimumDate="{Binding MinDate}"
                                    MaximumDate="{Binding MaxDate}"
                                    BackgroundColor="{AppThemeBinding Light=White, Dark=#2C2C2E}"/>
                    </VerticalStackLayout>

                    <VerticalStackLayout Grid.Column="1" Spacing="8">
                        <Label Text="Время *" 
                               FontSize="14" 
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light=#333, Dark=White}"/>
                        <TimePicker Time="{Binding EventTime}"
                                    BackgroundColor="{AppThemeBinding Light=White, Dark=#2C2C2E}"/>
                    </VerticalStackLayout>
                </Grid>

                <!-- Местоположение -->
                <VerticalStackLayout Spacing="8">
                    <Label Text="Местоположение *" 
           FontSize="14" 
           FontAttributes="Bold"
           TextColor="{AppThemeBinding Light=#333, Dark=White}"/>

                    <!-- Поле ввода адреса -->
                    <Entry Placeholder="Введите адрес или название места..." 
           Text="{Binding Address}"
           BackgroundColor="{AppThemeBinding Light=White, Dark=#2C2C2E}"
           TextColor="{AppThemeBinding Light=Black, Dark=White}"
           HeightRequest="50"
           x:Name="AddressEntry"/>

                    <!-- Выпадающий список подсказок -->
                    <Frame IsVisible="{Binding AddressSuggestions.Count, Converter={converters:IsNotNullOrEmptyConverter}}"
           BackgroundColor="{AppThemeBinding Light=White, Dark=#2C2C2E}"
           BorderColor="{AppThemeBinding Light=#E0E0E0, Dark=#444}"
           Padding="0"
           CornerRadius="5"
           HasShadow="True">

                        <CollectionView HeightRequest="150"
                        SelectionMode="Single"
                        ItemsSource="{Binding AddressSuggestions}"
                        SelectedItem="{Binding SelectedSuggestion}">

                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid Padding="15,12" HeightRequest="44">
                                        <Label Text="{Binding .}"
                               FontSize="14"
                               TextColor="{AppThemeBinding Light=#333, Dark=White}"
                               LineBreakMode="TailTruncation"
                               VerticalOptions="Center"/>

                                        <VisualStateManager.VisualStateGroups>
                                            <VisualStateGroup x:Name="CommonStates">
                                                <VisualState x:Name="Normal">
                                                    <VisualState.Setters>
                                                        <Setter Property="BackgroundColor" Value="Transparent"/>
                                                    </VisualState.Setters>
                                                </VisualState>
                                                <VisualState x:Name="Selected">
                                                    <VisualState.Setters>
                                                        <Setter Property="BackgroundColor" Value="#DFD8F7"/>
                                                    </VisualState.Setters>
                                                </VisualState>
                                            </VisualStateGroup>
                                        </VisualStateManager.VisualStateGroups>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </Frame>

                    <!-- Статус выбора -->
                    <Label Text="{Binding SelectionStatus}"
           IsVisible="{Binding SelectionStatus, Converter={converters:IsNotNullOrEmptyConverter}}"
           FontSize="12"
           TextColor="#512BD4"
           FontAttributes="Bold"
           HorizontalOptions="Center"/>

                    <!-- Кнопки для работы с адресом -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="10" Margin="0,10,0,0">
                        <Button Grid.Column="0"
                Text="🎯 Мое местоположение"
                Command="{Binding GetCurrentLocationCommand}"
                BackgroundColor="#DFD8F7"
                TextColor="#512BD4"
                FontSize="12"
                FontAttributes="Bold"
                HeightRequest="40"
                CornerRadius="20"/>

                        <Button Grid.Column="1"
                Text="📌 На карте"
                Command="{Binding OpenMapSearchCommand}"
                BackgroundColor="#E3F2FD"
                TextColor="#1976D2"
                FontSize="12"
                FontAttributes="Bold"
                HeightRequest="40"
                CornerRadius="20"/>
                    </Grid>

                    <!-- Подсказка -->
                    <Label Text="Начните вводить адрес (минимум 2 символа)"
           FontSize="11"
           TextColor="Gray"
           HorizontalOptions="Center"/>

                    <!-- Скрытые поля для координат -->
                    <Entry Text="{Binding Latitude}" IsVisible="False"/>
                    <Entry Text="{Binding Longitude}" IsVisible="False"/>
                </VerticalStackLayout>

                <!-- Максимум участников -->
                <VerticalStackLayout Spacing="8">
                    <Label Text="Максимум участников" 
                           FontSize="14" 
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light=#333, Dark=White}"/>

                    <Grid ColumnDefinitions="*,*" ColumnSpacing="15">
                        <VerticalStackLayout Grid.Column="0" Spacing="5">
                            <Label Text="{Binding MaxParticipants, StringFormat='{0} участников'}"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="#512BD4"
                                   HorizontalOptions="Center"/>

                            <Label Text="Текущее значение" 
                                   FontSize="12"
                                   TextColor="Gray"
                                   HorizontalOptions="Center"/>
                        </VerticalStackLayout>

                        <Stepper Grid.Column="1"
                                 Value="{Binding MaxParticipants}"
                                 Minimum="2"
                                 Maximum="50"
                                 Increment="1"
                                 HorizontalOptions="Center"
                                 VerticalOptions="Center"/>
                    </Grid>
                </VerticalStackLayout>

                <!-- Кнопки -->
                <Grid ColumnDefinitions="*,*" ColumnSpacing="15" Margin="0,30">
                    <Button Grid.Column="0" 
                            Text="Отмена" 
                            Command="{Binding CancelCommand}"
                            BackgroundColor="{AppThemeBinding Light=#E0E0E0, Dark=#444}"
                            TextColor="{AppThemeBinding Light=Black, Dark=White}"
                            HeightRequest="50"
                            CornerRadius="10"/>

                    <Button Grid.Column="1" 
                            Text="Создать" 
                            Command="{Binding CreateEventCommand}"
                            BackgroundColor="#512BD4"
                            TextColor="White"
                            FontAttributes="Bold"
                            HeightRequest="50"
                            CornerRadius="10"/>
                </Grid>

                <!-- Индикатор загрузки -->
                <ActivityIndicator IsVisible="{Binding IsBusy}" 
                                 IsRunning="{Binding IsBusy}"
                                 Color="#512BD4"
                                 HorizontalOptions="Center"
                                 HeightRequest="50"/>

            </VerticalStackLayout>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>