<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="Point_v1.Views.CreateEventPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:Point_v1.Converters"
             Title="Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ"
             BackgroundColor="{AppThemeBinding Light=#F8F9FA, Dark=#1C1C1E}">

    <ContentPage.Resources>
        <converters:BoolToColorConverter x:Key="BoolToColorConverter" />
        <converters:BoolToTextColorConverter x:Key="BoolToTextColorConverter" />
        <converters:BoolToBorderColorConverter x:Key="BoolToBorderColorConverter" />
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Spacing="16" Padding="20" BackgroundColor="Transparent">

            <!-- Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐ°Ñ… -->
            <Label Text="{Binding ErrorMessage}" 
                   IsVisible="{Binding ErrorMessage, Converter={converters:IsNotNullOrEmptyConverter}}"
                   TextColor="#D32F2F" 
                   FontSize="14"
                   HorizontalOptions="Center"
                   Padding="15,10"
                   HorizontalTextAlignment="Center"/>

            <!-- ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ -->
            <VerticalStackLayout Spacing="8">
                <Label Text="ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ *" 
                       Style="{StaticResource FormLabel}"/>
                <Entry Placeholder="ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: Ð’ÐµÑ‡ÐµÑ€ Ð½Ð°ÑÑ‚Ð¾Ð»ÑŒÐ½Ñ‹Ñ… Ð¸Ð³Ñ€" 
                       Text="{Binding Title}"/>
            </VerticalStackLayout>

            <!-- ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ -->
            <VerticalStackLayout Spacing="8">
                <Label Text="ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ *" 
                       Style="{StaticResource FormLabel}"/>
                <Editor Placeholder="ÐžÐ¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð²Ð°ÑˆÐµ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ðµ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½ÐµÐµ..." 
                        Text="{Binding Description}"
                        HeightRequest="120"
                        AutoSize="TextChanges"/>
            </VerticalStackLayout>

            <!-- ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ -->
            <VerticalStackLayout Spacing="8">
                <Label Text="ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ * (Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼ 3)" 
                       Style="{StaticResource FormLabel}"/>
                <Label Text="{Binding CategoriesStatus}" 
                       FontSize="12"
                       TextColor="Gray"
                       Margin="0,-4,0,4"/>
                <ScrollView HeightRequest="200">
                    <FlexLayout BindableLayout.ItemsSource="{Binding Interests}"
                                Direction="Row"
                                Wrap="Wrap"
                                JustifyContent="Start"
                                AlignItems="Start"
                                AlignContent="Start">
                        <BindableLayout.ItemTemplate>
                            <DataTemplate>
                                <Button Text="{Binding Name}"
                                        Clicked="OnCategoryClicked"
                                        BackgroundColor="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}}"
                                        TextColor="{Binding IsSelected, Converter={StaticResource BoolToTextColorConverter}}"
                                        CornerRadius="20"
                                        Padding="16,8"
                                        Margin="4"
                                        FontSize="14"
                                        BorderWidth="1"
                                        BorderColor="{Binding IsSelected, Converter={StaticResource BoolToBorderColorConverter}}"/>
                            </DataTemplate>
                        </BindableLayout.ItemTemplate>
                    </FlexLayout>
                </ScrollView>
            </VerticalStackLayout>

            <!-- Ð”Ð°Ñ‚Ð° Ð¸ Ð²Ñ€ÐµÐ¼Ñ -->
            <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                <VerticalStackLayout Grid.Column="0" Spacing="8">
                    <Label Text="Ð”Ð°Ñ‚Ð° *" 
                           Style="{StaticResource FormLabel}"/>
                    <DatePicker Date="{Binding EventDate}"
                                MinimumDate="{Binding MinDate}"
                                MaximumDate="{Binding MaxDate}"/>
                </VerticalStackLayout>

                <VerticalStackLayout Grid.Column="1" Spacing="8">
                    <Label Text="Ð’Ñ€ÐµÐ¼Ñ *" 
                           Style="{StaticResource FormLabel}"/>
                    <TimePicker Time="{Binding EventTime}"/>
                </VerticalStackLayout>
            </Grid>

            <!-- ÐœÐµÑÑ‚Ð¾Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ -->
            <VerticalStackLayout Spacing="8">
                <Label Text="ÐœÐµÑÑ‚Ð¾Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ *" 
                       Style="{StaticResource FormLabel}"/>

                <!-- ÐŸÐ¾Ð»Ðµ Ð²Ð²Ð¾Ð´Ð° Ð°Ð´Ñ€ÐµÑÐ° -->
                <Entry Placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð°Ð´Ñ€ÐµÑ Ð¸Ð»Ð¸ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð¼ÐµÑÑ‚Ð°..." 
                       Text="{Binding Address}"
                       x:Name="AddressEntry"/>

                <!-- Ð’Ñ‹Ð¿Ð°Ð´Ð°ÑŽÑ‰Ð¸Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¿Ð¾Ð´ÑÐºÐ°Ð·Ð¾Ðº -->
                <Frame IsVisible="{Binding AddressSuggestions.Count, Converter={converters:IsNotNullOrEmptyConverter}}"
                       BackgroundColor="{AppThemeBinding Light=White, Dark=#2C2C2E}"
                       BorderColor="{AppThemeBinding Light=#E0E0E0, Dark=#444}"
                       Padding="0"
                       CornerRadius="12"
                       HasShadow="True">

                    <CollectionView HeightRequest="150"
                                    SelectionMode="Single"
                                    ItemsSource="{Binding AddressSuggestions}"
                                    SelectedItem="{Binding SelectedSuggestion}">

                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="15,12" HeightRequest="44">
                                    <Label Text="{Binding .}"
                                           FontSize="14"
                                           TextColor="{AppThemeBinding Light=#333, Dark=White}"
                                           LineBreakMode="TailTruncation"
                                           VerticalOptions="Center"/>

                                    <VisualStateManager.VisualStateGroups>
                                        <VisualStateGroup x:Name="CommonStates">
                                            <VisualState x:Name="Normal">
                                                <VisualState.Setters>
                                                    <Setter Property="BackgroundColor" Value="Transparent"/>
                                                </VisualState.Setters>
                                            </VisualState>
                                            <VisualState x:Name="Selected">
                                                <VisualState.Setters>
                                                    <Setter Property="BackgroundColor" Value="#DFD8F7"/>
                                                </VisualState.Setters>
                                            </VisualState>
                                        </VisualStateGroup>
                                    </VisualStateManager.VisualStateGroups>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </Frame>

                <!-- Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð²Ñ‹Ð±Ð¾Ñ€Ð° -->
                <Label Text="{Binding SelectionStatus}"
                       IsVisible="{Binding SelectionStatus, Converter={converters:IsNotNullOrEmptyConverter}}"
                       FontSize="12"
                       TextColor="#512BD4"
                       FontAttributes="Bold"
                       HorizontalOptions="Center"/>

                <!-- ÐšÐ½Ð¾Ð¿ÐºÐ¸ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ð°Ð´Ñ€ÐµÑÐ¾Ð¼ -->
                <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                    <Button Grid.Column="0"
                            Text="ðŸŽ¯ ÐœÐ¾Ðµ Ð¼ÐµÑÑ‚Ð¾Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ"
                            Command="{Binding GetCurrentLocationCommand}"
                            Style="{StaticResource SmallButton}"
                            BackgroundColor="#DFD8F7"
                            TextColor="#512BD4"/>

                    <Button Grid.Column="1"
                            Text="ðŸ—ºï¸ ÐÐ° ÐºÐ°Ñ€Ñ‚Ðµ"
                            Command="{Binding OpenMapSearchCommand}"
                            Style="{StaticResource SmallButton}"
                            BackgroundColor="#E3F2FD"
                            TextColor="#1976D2"/>
                </Grid>

                <!-- ÐŸÐ¾Ð´ÑÐºÐ°Ð·ÐºÐ° -->
                <Label Text="ÐÐ°Ñ‡Ð½Ð¸Ñ‚Ðµ Ð²Ð²Ð¾Ð´Ð¸Ñ‚ÑŒ Ð°Ð´Ñ€ÐµÑ (Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ 2 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð°)"
                       FontSize="11"
                       TextColor="Gray"
                       HorizontalOptions="Center"/>

                <!-- Ð¡ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ Ð¿Ð¾Ð»Ñ Ð´Ð»Ñ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚ -->
                <Entry Text="{Binding Latitude}" IsVisible="False"/>
                <Entry Text="{Binding Longitude}" IsVisible="False"/>
            </VerticalStackLayout>

            <!-- ÐœÐ°ÐºÑÐ¸Ð¼ÑƒÐ¼ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð² -->
            <VerticalStackLayout Spacing="8">
                <Label Text="ÐœÐ°ÐºÑÐ¸Ð¼ÑƒÐ¼ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²" 
                       Style="{StaticResource FormLabel}"/>

                <Grid ColumnDefinitions="*,*" ColumnSpacing="15">
                    <VerticalStackLayout Grid.Column="0" Spacing="5">
                        <Label Text="{Binding MaxParticipants, StringFormat='{0} ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²'}"
                               FontSize="16"
                               FontAttributes="Bold"
                               TextColor="#512BD4"
                               HorizontalOptions="Center"/>

                        <Label Text="Ð¢ÐµÐºÑƒÑ‰ÐµÐµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ" 
                               FontSize="12"
                               TextColor="Gray"
                               HorizontalOptions="Center"/>
                    </VerticalStackLayout>

                    <Stepper Grid.Column="1"
                             Value="{Binding MaxParticipants}"
                             Minimum="2"
                             Maximum="50"
                             Increment="1"
                             HorizontalOptions="Center"
                             VerticalOptions="Center"/>
                </Grid>
            </VerticalStackLayout>

            <!-- ÐšÐ½Ð¾Ð¿ÐºÐ¸ -->
            <Grid ColumnDefinitions="*,*" ColumnSpacing="12" Margin="0,12,0,0">
                <Button Grid.Column="0" 
                        Text="ÐžÑ‚Ð¼ÐµÐ½Ð°" 
                        Command="{Binding CancelCommand}"
                        Style="{StaticResource OutlineButton}"/>

                <Button Grid.Column="1" 
                        Text="Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ" 
                        Command="{Binding CreateEventCommand}"/>
            </Grid>

            <!-- Ð˜Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ -->
            <ActivityIndicator IsVisible="{Binding IsBusy}" 
                             IsRunning="{Binding IsBusy}"
                             Color="#512BD4"
                             HorizontalOptions="Center"
                             HeightRequest="50"
                             Margin="0,20,0,0"/>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>